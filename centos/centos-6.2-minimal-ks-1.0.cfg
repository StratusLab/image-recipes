# Kickstart file automatically generated by anaconda.

#version=DEVEL
install
text

lang en_US.UTF-8
keyboard us-acentos

network --onboot yes --device eth0 --bootproto dhcp --noipv6

rootpw  --iscrypted $6$ski7L2pLPtnx3Jov$Yw9pvZIP55BLKX.2qCFPjjlcMQwAvZCt/Lv5fV4TqBnzDfJa1ENnGwL12uh8d5UTRAp1KllfyhySHInX3UPG60

firewall --service=ssh
authconfig --enableshadow --passalgo=sha512
selinux --disabled
timezone --utc Etc/UTC

# The following is the partition information you requested
# Note that any partitions you deleted are not expressed
# here so unless you clear all partitions first, this is
# not guaranteed to work
clearpart --all --drives=sda --initlabel

part /boot --fstype=ext4 --size=500        --ondisk=sda --asprimary
part /     --fstype=ext4 --size=1   --grow --ondisk=sda --asprimary

#part swap --fstype=swap --size=1 --grow --ondisk=sdb --asprimary

bootloader --location=mbr --driveorder=sda --append=" rhgb crashkernel=auto quiet"

repo --name="CentOS"     --baseurl=http://mirror.centos.org/centos/6/os/x86_64/ 
repo --name="StratusLab" --baseurl=http://yum.stratuslab.eu/snapshots/fedora14/

#
# Action at the end of the installation.
#
poweroff
#halt
#reboot

%packages --nobase
@client-mgmt-tools
@core
@server-policy
openssh
openssh-clients
openssh-server
stratuslab-one-context

%post

yum upgrade -y --nogpgcheck

# Set the cdrom block device to use for contextualisation
sed -i 's/context_device.*$/context_device=sr0/' /etc/stratuslab/stratuslab-one-context.cfg

#
# Disable filesystem checks on volumes.
#
tune2fs -c 0 -i 0 /dev/sda1
tune2fs -c 0 -i 0 /dev/sda2

#
# Remove any occurrences of the mac address
#
rm /etc/udev/rules.d/70-persistent-*.rules
sed -i 's/HWADDR.*$//' /etc/sysconfig/network-scripts/ifcfg-eth0

#
# Remove reference to installation hostname in network configuration
#
sed -i "/HOSTNAME/d" /etc/sysconfig/network

#
# Secure the SSH daemon by shutting down non-key access.
# 
sed s/PasswordAuthentication\ yes/PasswordAuthentication\ no/ -i /etc/ssh/sshd_config
sed s/GSSAPIAuthentication\ yes/GSSAPIAuthentication\ no/ -i /etc/ssh/sshd_config
sed s/ChallengeResponseAuthentication\ yes/ChallengeResponseAuthentication\ no/ -i /etc/ssh/sshd_config
echo "PermitRootLogin without-password" >> /etc/ssh/sshd_config

# Add sdb swap disk in the fstab
echo "/dev/sdb swap swap defaults 0 0" >> /etc/fstab
#Load acpiphp module
echo "modprobe acpiphp" >> /etc/rc.local
#
# Randomize root password now.
#
#dd if=/dev/urandom count=50|sha512sum|passwd --stdin root

%end
