# Kickstart file automatically generated by anaconda.

#version=DEVEL
install
text

lang en_US.UTF-8
keyboard us-acentos

network --onboot yes --device eth0 --bootproto dhcp 
rootpw  --iscrypted $6$ski7L2pLPtnx3Jov$Yw9pvZIP55BLKX.2qCFPjjlcMQwAvZCt/Lv5fV4TqBnzDfJa1ENnGwL12uh8d5UTRAp1KllfyhySHInX3UPG60

firewall --disabled
authconfig --enableshadow --passalgo=sha512
selinux --disabled
timezone --utc Etc/UTC

# The following is the partition information you requested
# Note that any partitions you deleted are not expressed
# here so unless you clear all partitions first, this is
# not guaranteed to work


#bootloader --location=mbr --driveorder=sda --append=" rhgb crashkernel=auto quiet"
zerombr
clearpart --all --initlabel

bootloader --location=mbr --driveorder=sda --append=" rhgb crashkernel=auto quiet"

#part /boot --fstype=ext4 --size=500        --ondisk=sda --asprimary
part /     --fstype=ext4 --size=1   --grow --ondisk=sda --asprimary

#part swap --fstype=swap --size=1 --grow --ondisk=sdb --asprimary


repo --name="CentOS"     --baseurl=http://mirrors.ircam.fr/pub/CentOS/6/os/x86_64/  --cost=1
repo --name="StratusLab" --baseurl=http://yum.stratuslab.eu/releases/centos-6/  --cost=10
#repo updates enabled
#
# Action at the end of the installation.
#
poweroff
#halt
#reboot

%packages --nobase
@client-mgmt-tools
@core
@server-policy
openssh
openssh-clients
openssh-server
acpid
wget
unzip
zip
stratuslab-contextualization

%post
yum upgrade -y --nogpgcheck


# Set the cdrom block device to use for contextualisation
sed -i 's/context_device.*$/context_device=sr0/' /etc/stratuslab/stratuslab-one-context.cfg

#
# Disable filesystem checks on volumes.
#
tune2fs -c 0 -i 0 /dev/sda1
tune2fs -c 0 -i 0 /dev/sda2

#
# Turn off udev caching of network information.
#

rm -f /lib/udev/rules.d/*net-gen*
rm -f /etc/udev/rules.d/*net.rules


sed -i 's/HWADDR.*$//' /etc/sysconfig/network-scripts/ifcfg-eth0
echo "DHCPV6C=yes" >> /etc/sysconfig/network-scripts/ifcfg-eth0
echo "DHCPV6C_OPTIONS=\"-timeout 5\"" >> /etc/sysconfig/network-scripts/ifcfg-eth0

#
# Remove reference to installation hostname in network configuration
#
sed -i "/HOSTNAME/d" /etc/sysconfig/network

# Download, install, and configure cloud-init

rpm -Uvh http://download.fedoraproject.org/pub/epel/6/i386/epel-release-6-8.noarch.rpm

yum install -y cloud-init


sed -i 's/user: ec2-user/user: root/' /etc/cloud/cloud.cfg
sed -i 's/disable_root: 1/disable_root: 0/' /etc/cloud/cloud.cfg

#
# Secure the SSH daemon by shutting down non-key access.
# 
sed s/PasswordAuthentication\ yes/PasswordAuthentication\ no/ -i /etc/ssh/sshd_config
sed s/GSSAPIAuthentication\ yes/GSSAPIAuthentication\ no/ -i /etc/ssh/sshd_config
sed s/ChallengeResponseAuthentication\ yes/ChallengeResponseAuthentication\ no/ -i /etc/ssh/sshd_config
echo "PermitRootLogin without-password" >> /etc/ssh/sshd_config

# Add sdb swap disk in the fstab
echo "/dev/vdb swap swap defaults 0 0" >> /etc/fstab
#
# Randomize root password now.
#
#dd if=/dev/urandom count=50|sha512sum|passwd --stdin root

#disable epel repo
#sed -i 's/enabled=1/enabled=0/' /etc/yum.repos.d/epel.repo
#rpm -e epel-release-6-8.noarch 

#https://github.com/StratusLab/image-recipes/issues/14
#cloud-init 0.6.3 UserDataHandler.py
#cloud-init 0.7.4 user_data.py
for f in UserDataHandler.py user_data.py; do
[ -f /usr/lib/python2.6/site-packages/cloudinit/$f ] || continue
sed -i '
/        msg = email.message_from_string(data)/c\
        if isinstance(data, unicode):\
            msg = email.message_from_string(data.encode('\'utf-8\''))\
        else:\
            msg = email.message_from_string(data)
' /usr/lib/python2.6/site-packages/cloudinit/$f
break
done

%end
